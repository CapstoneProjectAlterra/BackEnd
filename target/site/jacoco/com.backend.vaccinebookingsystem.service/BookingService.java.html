<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>BookingService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">vaccine-booking-system</a> &gt; <a href="index.source.html" class="el_package">com.backend.vaccinebookingsystem.service</a> &gt; <span class="el_source">BookingService.java</span></div><h1>BookingService.java</h1><pre class="source lang-java linenums">package com.backend.vaccinebookingsystem.service;

import com.backend.vaccinebookingsystem.constant.AppConstant;
import com.backend.vaccinebookingsystem.domain.dao.BookingDao;
import com.backend.vaccinebookingsystem.domain.dao.ScheduleDao;
import com.backend.vaccinebookingsystem.domain.dao.UserDao;
import com.backend.vaccinebookingsystem.domain.dto.*;
import com.backend.vaccinebookingsystem.repository.BookingRepository;
import com.backend.vaccinebookingsystem.repository.ScheduleRepository;
import com.backend.vaccinebookingsystem.repository.UserRepository;
import com.backend.vaccinebookingsystem.util.ResponseUtil;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;

<span class="fc" id="L23">@Slf4j</span>
@Service
<span class="fc" id="L25">public class BookingService {</span>

    @Autowired
    private BookingRepository bookingRepository;

    @Autowired
    private ScheduleRepository scheduleRepository;

    @Autowired
    private UserRepository userRepository;

    @Transactional
    public ResponseEntity&lt;Object&gt; createBooking(BookingDto bookingDto) {
        try {
<span class="fc" id="L39">            log.info(&quot;Creating new Booking. Value {}&quot;, bookingDto);</span>

<span class="pc" id="L41">            Optional&lt;BookingDao&gt; optionalBookingDaoScheduleId = bookingRepository.findFirstByScheduleIdOrderByIdDesc(</span>
<span class="nc" id="L42">                    bookingDto.getSchedule().getId());</span>

<span class="nc" id="L44">            Optional&lt;ScheduleDao&gt; optionalScheduleDao = scheduleRepository.findById(bookingDto.getSchedule().getId());</span>

<span class="nc" id="L46">            Optional&lt;UserDao&gt; optionalUserDao = userRepository.findById(bookingDto.getUser().getId());</span>

<span class="nc bnc" id="L48" title="All 4 branches missed.">            if (optionalScheduleDao.isEmpty() || optionalUserDao.isEmpty()) {</span>
<span class="nc" id="L49">                log.info(&quot;Booking not found&quot;);</span>
<span class="nc" id="L50">                return ResponseUtil.build(AppConstant.ResponseCode.DATA_NOT_FOUND, null, HttpStatus.BAD_REQUEST);</span>
            }

<span class="nc bnc" id="L53" title="All 2 branches missed.">            if (optionalBookingDaoScheduleId.isEmpty()) {</span>
<span class="nc" id="L54">                log.info(&quot;Find first empty&quot;);</span>
<span class="nc" id="L55">                BookingDao bookingDao = BookingDao.builder()</span>
<span class="nc" id="L56">                        .id(bookingDto.getId())</span>
<span class="nc" id="L57">                        .bookingPass(1)</span>
<span class="nc" id="L58">                        .bookingDate(bookingDto.getBookingDate())</span>
<span class="nc" id="L59">                        .user(optionalUserDao.get())</span>
<span class="nc" id="L60">                        .schedule(optionalScheduleDao.get())</span>
<span class="nc" id="L61">                        .build();</span>

<span class="nc" id="L63">                bookingRepository.save(bookingDao);</span>

<span class="nc" id="L65">                BookingDto dto = BookingDto.builder()</span>
<span class="nc" id="L66">                        .id(bookingDao.getId())</span>
<span class="nc" id="L67">                        .bookingPass(bookingDao.getBookingPass())</span>
<span class="nc" id="L68">                        .bookingDate(bookingDao.getBookingDate())</span>
<span class="nc" id="L69">                        .user(UserDto.builder()</span>
<span class="nc" id="L70">                                .id(bookingDao.getUser().getId())</span>
<span class="nc" id="L71">                                .username(bookingDao.getUser().getUsername())</span>
<span class="nc" id="L72">                                .name(bookingDao.getUser().getName())</span>
<span class="nc" id="L73">                                .email(bookingDao.getUser().getEmail())</span>
<span class="nc" id="L74">                                .password(bookingDao.getUser().getPassword())</span>
<span class="nc" id="L75">                                .profile(ProfileDto.builder()</span>
<span class="nc" id="L76">                                        .userId(optionalUserDao.get().getProfile().getUserId())</span>
<span class="nc" id="L77">                                        .role(optionalUserDao.get().getProfile().getRole())</span>
<span class="nc" id="L78">                                        .build())</span>
<span class="nc" id="L79">                                .build())</span>
<span class="nc" id="L80">                        .schedule(ScheduleDto.builder()</span>
<span class="nc" id="L81">                                .id(bookingDao.getSchedule().getId())</span>
<span class="nc" id="L82">                                .vaccinationDate(bookingDao.getSchedule().getVaccinationDate())</span>
<span class="nc" id="L83">                                .operationalHourStart(bookingDao.getSchedule().getOperationalHourStart())</span>
<span class="nc" id="L84">                                .operationalHourEnd(bookingDao.getSchedule().getOperationalHourEnd())</span>
<span class="nc" id="L85">                                .quota(bookingDao.getSchedule().getQuota())</span>
<span class="nc" id="L86">                                .dose(bookingDao.getSchedule().getDose())</span>
<span class="nc" id="L87">                                .facility(HealthFacilityDto.builder()</span>
<span class="nc" id="L88">                                        .id(optionalScheduleDao.get().getFacility().getId())</span>
<span class="nc" id="L89">                                        .facilityName(optionalScheduleDao.get().getFacility().getFacilityName())</span>
<span class="nc" id="L90">                                        .streetName(optionalScheduleDao.get().getFacility().getStreetName())</span>
<span class="nc" id="L91">                                        .officeNumber(optionalScheduleDao.get().getFacility().getOfficeNumber())</span>
<span class="nc" id="L92">                                        .villageName(optionalScheduleDao.get().getFacility().getVillageName())</span>
<span class="nc" id="L93">                                        .district(optionalScheduleDao.get().getFacility().getDistrict())</span>
<span class="nc" id="L94">                                        .city(optionalScheduleDao.get().getFacility().getCity())</span>
<span class="nc" id="L95">                                        .province(optionalScheduleDao.get().getFacility().getProvince())</span>
<span class="nc" id="L96">                                        .postalCode(optionalScheduleDao.get().getFacility().getPostalCode())</span>
<span class="nc" id="L97">                                        .profile(ProfileDto.builder()</span>
<span class="nc" id="L98">                                                .userId(optionalScheduleDao.get().getFacility().getProfile().getUserId())</span>
<span class="nc" id="L99">                                                .role(optionalScheduleDao.get().getFacility().getProfile().getRole())</span>
<span class="nc" id="L100">                                                .build())</span>
<span class="nc" id="L101">                                        .build())</span>
<span class="nc" id="L102">                                .vaccine(VaccineTypeDto.builder()</span>
<span class="nc" id="L103">                                        .id(optionalScheduleDao.get().getVaccine().getId())</span>
<span class="nc" id="L104">                                        .vaccineName(optionalScheduleDao.get().getVaccine().getVaccineName())</span>
<span class="nc" id="L105">                                        .build())</span>
<span class="nc" id="L106">                                .build())</span>
<span class="nc" id="L107">                        .build();</span>

<span class="nc" id="L109">                return ResponseUtil.build(AppConstant.ResponseCode.SUCCESS, dto, HttpStatus.OK);</span>
            }

<span class="nc" id="L112">            log.info(&quot;Find first present&quot;);</span>
<span class="nc" id="L113">            BookingDao bookingDao = BookingDao.builder()</span>
<span class="nc" id="L114">                    .id(bookingDto.getId())</span>
<span class="nc" id="L115">                    .bookingPass(optionalBookingDaoScheduleId.get().getBookingPass() + 1)</span>
<span class="nc" id="L116">                    .bookingDate(bookingDto.getBookingDate())</span>
<span class="nc" id="L117">                    .user(optionalUserDao.get())</span>
<span class="nc" id="L118">                    .schedule(optionalScheduleDao.get())</span>
<span class="nc" id="L119">                    .build();</span>

<span class="nc" id="L121">            bookingRepository.save(bookingDao);</span>

<span class="nc" id="L123">            BookingDto dto = BookingDto.builder()</span>
<span class="nc" id="L124">                    .id(bookingDao.getId())</span>
<span class="nc" id="L125">                    .bookingPass(bookingDao.getBookingPass())</span>
<span class="nc" id="L126">                    .bookingDate(bookingDao.getBookingDate())</span>
<span class="nc" id="L127">                    .user(UserDto.builder()</span>
<span class="nc" id="L128">                            .id(bookingDao.getUser().getId())</span>
<span class="nc" id="L129">                            .username(bookingDao.getUser().getUsername())</span>
<span class="nc" id="L130">                            .name(bookingDao.getUser().getName())</span>
<span class="nc" id="L131">                            .email(bookingDao.getUser().getEmail())</span>
<span class="nc" id="L132">                            .password(bookingDao.getUser().getPassword())</span>
<span class="nc" id="L133">                            .profile(ProfileDto.builder()</span>
<span class="nc" id="L134">                                    .userId(optionalUserDao.get().getProfile().getUserId())</span>
<span class="nc" id="L135">                                    .role(optionalUserDao.get().getProfile().getRole())</span>
<span class="nc" id="L136">                                    .build())</span>
<span class="nc" id="L137">                            .build())</span>
<span class="nc" id="L138">                    .schedule(ScheduleDto.builder()</span>
<span class="nc" id="L139">                            .id(bookingDao.getSchedule().getId())</span>
<span class="nc" id="L140">                            .vaccinationDate(bookingDao.getSchedule().getVaccinationDate())</span>
<span class="nc" id="L141">                            .operationalHourStart(bookingDao.getSchedule().getOperationalHourStart())</span>
<span class="nc" id="L142">                            .operationalHourEnd(bookingDao.getSchedule().getOperationalHourEnd())</span>
<span class="nc" id="L143">                            .quota(bookingDao.getSchedule().getQuota())</span>
<span class="nc" id="L144">                            .dose(bookingDao.getSchedule().getDose())</span>
<span class="nc" id="L145">                            .facility(HealthFacilityDto.builder()</span>
<span class="nc" id="L146">                                    .id(optionalScheduleDao.get().getFacility().getId())</span>
<span class="nc" id="L147">                                    .facilityName(optionalScheduleDao.get().getFacility().getFacilityName())</span>
<span class="nc" id="L148">                                    .streetName(optionalScheduleDao.get().getFacility().getStreetName())</span>
<span class="nc" id="L149">                                    .officeNumber(optionalScheduleDao.get().getFacility().getOfficeNumber())</span>
<span class="nc" id="L150">                                    .villageName(optionalScheduleDao.get().getFacility().getVillageName())</span>
<span class="nc" id="L151">                                    .district(optionalScheduleDao.get().getFacility().getDistrict())</span>
<span class="nc" id="L152">                                    .city(optionalScheduleDao.get().getFacility().getCity())</span>
<span class="nc" id="L153">                                    .province(optionalScheduleDao.get().getFacility().getProvince())</span>
<span class="nc" id="L154">                                    .postalCode(optionalScheduleDao.get().getFacility().getPostalCode())</span>
<span class="nc" id="L155">                                    .profile(ProfileDto.builder()</span>
<span class="nc" id="L156">                                            .userId(optionalScheduleDao.get().getFacility().getProfile().getUserId())</span>
<span class="nc" id="L157">                                            .role(optionalScheduleDao.get().getFacility().getProfile().getRole())</span>
<span class="nc" id="L158">                                            .build())</span>
<span class="nc" id="L159">                                    .build())</span>
<span class="nc" id="L160">                            .vaccine(VaccineTypeDto.builder()</span>
<span class="nc" id="L161">                                    .id(optionalScheduleDao.get().getVaccine().getId())</span>
<span class="nc" id="L162">                                    .vaccineName(optionalScheduleDao.get().getVaccine().getVaccineName())</span>
<span class="nc" id="L163">                                    .build())</span>
<span class="nc" id="L164">                            .build())</span>
<span class="nc" id="L165">                    .build();</span>

<span class="nc" id="L167">            return ResponseUtil.build(AppConstant.ResponseCode.SUCCESS, dto, HttpStatus.OK);</span>
<span class="fc" id="L168">        } catch (Exception e) {</span>
<span class="fc" id="L169">            log.error(&quot;An error occurred in creating new Booking. Error: {}&quot;, e.getMessage());</span>
<span class="fc" id="L170">            return ResponseUtil.build(AppConstant.ResponseCode.UNKNOWN_ERROR, null, HttpStatus.INTERNAL_SERVER_ERROR);</span>
        }
    }

    public ResponseEntity&lt;Object&gt; getBookingById(Long id) {
        try {
<span class="fc" id="L176">            log.info(&quot;Getting a Booking by id&quot;);</span>
<span class="fc" id="L177">            Optional&lt;BookingDao&gt; optionalBookingDao = bookingRepository.findById(id);</span>

<span class="fc" id="L179">            Optional&lt;ScheduleDao&gt; optionalScheduleDao = scheduleRepository.findById(optionalBookingDao.get().getSchedule().getId());</span>

<span class="fc" id="L181">            Optional&lt;UserDao&gt; optionalUserDao = userRepository.findById(optionalBookingDao.get().getUser().getId());</span>

<span class="pc bpc" id="L183" title="3 of 6 branches missed.">            if (optionalBookingDao.isEmpty() || optionalScheduleDao.isEmpty() || optionalUserDao.isEmpty()) {</span>
<span class="nc" id="L184">                log.info(&quot;Booking not found&quot;);</span>
<span class="nc" id="L185">                return ResponseUtil.build(AppConstant.ResponseCode.DATA_NOT_FOUND, null, HttpStatus.BAD_REQUEST);</span>
            }

<span class="fc" id="L188">            log.info(&quot;Booking found&quot;);</span>
<span class="fc" id="L189">            BookingDto dto = BookingDto.builder()</span>
<span class="fc" id="L190">                    .id(optionalBookingDao.get().getId())</span>
<span class="fc" id="L191">                    .bookingPass(optionalBookingDao.get().getBookingPass())</span>
<span class="fc" id="L192">                    .bookingDate(optionalBookingDao.get().getBookingDate())</span>
<span class="fc" id="L193">                    .user(UserDto.builder()</span>
<span class="fc" id="L194">                            .id(optionalBookingDao.get().getUser().getId())</span>
<span class="fc" id="L195">                            .username(optionalBookingDao.get().getUser().getUsername())</span>
<span class="fc" id="L196">                            .name(optionalBookingDao.get().getUser().getName())</span>
<span class="fc" id="L197">                            .email(optionalBookingDao.get().getUser().getEmail())</span>
<span class="fc" id="L198">                            .password(optionalBookingDao.get().getUser().getPassword())</span>
<span class="fc" id="L199">                            .profile(ProfileDto.builder()</span>
<span class="fc" id="L200">                                    .userId(optionalUserDao.get().getProfile().getUserId())</span>
<span class="fc" id="L201">                                    .role(optionalUserDao.get().getProfile().getRole())</span>
<span class="fc" id="L202">                                    .build())</span>
<span class="fc" id="L203">                            .build())</span>
<span class="fc" id="L204">                    .schedule(ScheduleDto.builder()</span>
<span class="fc" id="L205">                            .id(optionalBookingDao.get().getSchedule().getId())</span>
<span class="fc" id="L206">                            .vaccinationDate(optionalBookingDao.get().getSchedule().getVaccinationDate())</span>
<span class="fc" id="L207">                            .operationalHourStart(optionalBookingDao.get().getSchedule().getOperationalHourStart())</span>
<span class="fc" id="L208">                            .operationalHourEnd(optionalBookingDao.get().getSchedule().getOperationalHourEnd())</span>
<span class="fc" id="L209">                            .quota(optionalBookingDao.get().getSchedule().getQuota())</span>
<span class="fc" id="L210">                            .dose(optionalBookingDao.get().getSchedule().getDose())</span>
<span class="fc" id="L211">                            .facility(HealthFacilityDto.builder()</span>
<span class="fc" id="L212">                                    .id(optionalScheduleDao.get().getFacility().getId())</span>
<span class="fc" id="L213">                                    .facilityName(optionalScheduleDao.get().getFacility().getFacilityName())</span>
<span class="fc" id="L214">                                    .streetName(optionalScheduleDao.get().getFacility().getStreetName())</span>
<span class="fc" id="L215">                                    .officeNumber(optionalScheduleDao.get().getFacility().getOfficeNumber())</span>
<span class="fc" id="L216">                                    .villageName(optionalScheduleDao.get().getFacility().getVillageName())</span>
<span class="fc" id="L217">                                    .district(optionalScheduleDao.get().getFacility().getDistrict())</span>
<span class="fc" id="L218">                                    .city(optionalScheduleDao.get().getFacility().getCity())</span>
<span class="fc" id="L219">                                    .province(optionalScheduleDao.get().getFacility().getProvince())</span>
<span class="fc" id="L220">                                    .postalCode(optionalScheduleDao.get().getFacility().getPostalCode())</span>
<span class="fc" id="L221">                                    .profile(ProfileDto.builder()</span>
<span class="fc" id="L222">                                            .userId(optionalScheduleDao.get().getFacility().getProfile().getUserId())</span>
<span class="fc" id="L223">                                            .role(optionalScheduleDao.get().getFacility().getProfile().getRole())</span>
<span class="fc" id="L224">                                            .build())</span>
<span class="fc" id="L225">                                    .build())</span>
<span class="fc" id="L226">                            .vaccine(VaccineTypeDto.builder()</span>
<span class="fc" id="L227">                                    .id(optionalScheduleDao.get().getVaccine().getId())</span>
<span class="fc" id="L228">                                    .vaccineName(optionalScheduleDao.get().getVaccine().getVaccineName())</span>
<span class="fc" id="L229">                                    .build())</span>
<span class="fc" id="L230">                            .build())</span>
<span class="fc" id="L231">                    .build();</span>
<span class="fc" id="L232">            return ResponseUtil.build(AppConstant.ResponseCode.SUCCESS, dto, HttpStatus.OK);</span>
<span class="nc" id="L233">        } catch (Exception e) {</span>
<span class="nc" id="L234">            log.error(&quot;An error occurred in getting a Booking by id. Error {}&quot;, e.getMessage());</span>
<span class="nc" id="L235">            throw e;</span>
        }
    }

    public ResponseEntity&lt;Object&gt; getAllBookings() {
        try {
<span class="fc" id="L241">            log.info(&quot;Getting all of Bookings&quot;);</span>
            List&lt;BookingDao&gt; bookingDaoList;
<span class="fc" id="L243">            List&lt;BookingDto&gt; bookingDtos = new ArrayList&lt;&gt;();</span>

<span class="fc" id="L245">            bookingDaoList = bookingRepository.findAll();</span>

<span class="pc bpc" id="L247" title="1 of 2 branches missed.">            for (BookingDao bookingDao : bookingDaoList) {</span>
<span class="nc" id="L248">                Optional&lt;ScheduleDao&gt; optionalScheduleDao = scheduleRepository.findById(bookingDao.getSchedule().getId());</span>

<span class="nc" id="L250">                Optional&lt;UserDao&gt; optionalUserDao = userRepository.findById(bookingDao.getUser().getId());</span>

<span class="nc" id="L252">                bookingDtos.add(BookingDto.builder()</span>
<span class="nc" id="L253">                        .id(bookingDao.getId())</span>
<span class="nc" id="L254">                        .bookingPass(bookingDao.getBookingPass())</span>
<span class="nc" id="L255">                        .bookingDate(bookingDao.getBookingDate())</span>
<span class="nc" id="L256">                        .user(UserDto.builder()</span>
<span class="nc" id="L257">                                .id(bookingDao.getUser().getId())</span>
<span class="nc" id="L258">                                .username(bookingDao.getUser().getUsername())</span>
<span class="nc" id="L259">                                .name(bookingDao.getUser().getName())</span>
<span class="nc" id="L260">                                .email(bookingDao.getUser().getEmail())</span>
<span class="nc" id="L261">                                .password(bookingDao.getUser().getPassword())</span>
<span class="nc" id="L262">                                .profile(ProfileDto.builder()</span>
<span class="nc" id="L263">                                        .userId(optionalUserDao.get().getProfile().getUserId())</span>
<span class="nc" id="L264">                                        .role(optionalUserDao.get().getProfile().getRole())</span>
<span class="nc" id="L265">                                        .build())</span>
<span class="nc" id="L266">                                .build())</span>
<span class="nc" id="L267">                        .schedule(ScheduleDto.builder()</span>
<span class="nc" id="L268">                                .id(bookingDao.getSchedule().getId())</span>
<span class="nc" id="L269">                                .vaccinationDate(bookingDao.getSchedule().getVaccinationDate())</span>
<span class="nc" id="L270">                                .operationalHourStart(bookingDao.getSchedule().getOperationalHourStart())</span>
<span class="nc" id="L271">                                .operationalHourEnd(bookingDao.getSchedule().getOperationalHourEnd())</span>
<span class="nc" id="L272">                                .quota(bookingDao.getSchedule().getQuota())</span>
<span class="nc" id="L273">                                .dose(bookingDao.getSchedule().getDose())</span>
<span class="nc" id="L274">                                .facility(HealthFacilityDto.builder()</span>
<span class="nc" id="L275">                                        .id(optionalScheduleDao.get().getFacility().getId())</span>
<span class="nc" id="L276">                                        .facilityName(optionalScheduleDao.get().getFacility().getFacilityName())</span>
<span class="nc" id="L277">                                        .streetName(optionalScheduleDao.get().getFacility().getStreetName())</span>
<span class="nc" id="L278">                                        .officeNumber(optionalScheduleDao.get().getFacility().getOfficeNumber())</span>
<span class="nc" id="L279">                                        .villageName(optionalScheduleDao.get().getFacility().getVillageName())</span>
<span class="nc" id="L280">                                        .district(optionalScheduleDao.get().getFacility().getDistrict())</span>
<span class="nc" id="L281">                                        .city(optionalScheduleDao.get().getFacility().getCity())</span>
<span class="nc" id="L282">                                        .province(optionalScheduleDao.get().getFacility().getProvince())</span>
<span class="nc" id="L283">                                        .postalCode(optionalScheduleDao.get().getFacility().getPostalCode())</span>
<span class="nc" id="L284">                                        .profile(ProfileDto.builder()</span>
<span class="nc" id="L285">                                                .userId(optionalScheduleDao.get().getFacility().getProfile().getUserId())</span>
<span class="nc" id="L286">                                                .role(optionalScheduleDao.get().getFacility().getProfile().getRole())</span>
<span class="nc" id="L287">                                                .build())</span>
<span class="nc" id="L288">                                        .build())</span>
<span class="nc" id="L289">                                .vaccine(VaccineTypeDto.builder()</span>
<span class="nc" id="L290">                                        .id(optionalScheduleDao.get().getVaccine().getId())</span>
<span class="nc" id="L291">                                        .vaccineName(optionalScheduleDao.get().getVaccine().getVaccineName())</span>
<span class="nc" id="L292">                                        .build())</span>
<span class="nc" id="L293">                                .build())</span>
<span class="nc" id="L294">                        .build());</span>
<span class="nc" id="L295">            }</span>

<span class="fc" id="L297">            return ResponseUtil.build(AppConstant.ResponseCode.SUCCESS, bookingDtos, HttpStatus.OK);</span>
<span class="nc" id="L298">        } catch (Exception e) {</span>
<span class="nc" id="L299">            log.error(&quot;An error occurred in getting all of Bookings. Error {}&quot;, e.getMessage());</span>
<span class="nc" id="L300">            return ResponseUtil.build(AppConstant.ResponseCode.UNKNOWN_ERROR, null, HttpStatus.INTERNAL_SERVER_ERROR);</span>
        }
    }

    public ResponseEntity&lt;Object&gt; updateBookingById(Long id, BookingDto bookingDto) {
        try {
<span class="nc" id="L306">            log.info(&quot;Updating a Booking by id&quot;);</span>
<span class="nc" id="L307">            Optional&lt;BookingDao&gt; optionalBookingDao = bookingRepository.findById(id);</span>

<span class="nc" id="L309">            Optional&lt;ScheduleDao&gt; optionalScheduleDao = scheduleRepository.findById(bookingDto.getSchedule().getId());</span>

<span class="nc" id="L311">            Optional&lt;UserDao&gt; optionalUserDao = userRepository.findById(bookingDto.getUser().getId());</span>

<span class="nc bnc" id="L313" title="All 6 branches missed.">            if (optionalBookingDao.isEmpty() || optionalScheduleDao.isEmpty() || optionalUserDao.isEmpty()) {</span>
<span class="nc" id="L314">                log.info(&quot;Booking not found&quot;);</span>
<span class="nc" id="L315">                return ResponseUtil.build(AppConstant.ResponseCode.DATA_NOT_FOUND, null, HttpStatus.BAD_REQUEST);</span>
            }

<span class="nc" id="L318">            log.info(&quot;Booking found&quot;);</span>
<span class="nc" id="L319">            BookingDao bookingDao = optionalBookingDao.get();</span>
<span class="nc" id="L320">            bookingDao.setBookingPass(bookingDto.getBookingPass());</span>
<span class="nc" id="L321">            bookingDao.setBookingDate(bookingDto.getBookingDate());</span>
<span class="nc" id="L322">            bookingDao.setUser(optionalUserDao.get());</span>
<span class="nc" id="L323">            bookingDao.setSchedule(optionalScheduleDao.get());</span>
<span class="nc" id="L324">            bookingRepository.save(bookingDao);</span>

<span class="nc" id="L326">            BookingDto dto = BookingDto.builder()</span>
<span class="nc" id="L327">                    .id(bookingDao.getId())</span>
<span class="nc" id="L328">                    .bookingPass(bookingDao.getBookingPass())</span>
<span class="nc" id="L329">                    .bookingDate(bookingDao.getBookingDate())</span>
<span class="nc" id="L330">                    .user(UserDto.builder()</span>
<span class="nc" id="L331">                            .id(bookingDao.getUser().getId())</span>
<span class="nc" id="L332">                            .username(bookingDao.getUser().getUsername())</span>
<span class="nc" id="L333">                            .name(bookingDao.getUser().getName())</span>
<span class="nc" id="L334">                            .email(bookingDao.getUser().getEmail())</span>
<span class="nc" id="L335">                            .password(bookingDao.getUser().getPassword())</span>
<span class="nc" id="L336">                            .profile(ProfileDto.builder()</span>
<span class="nc" id="L337">                                    .userId(optionalUserDao.get().getProfile().getUserId())</span>
<span class="nc" id="L338">                                    .role(optionalUserDao.get().getProfile().getRole())</span>
<span class="nc" id="L339">                                    .build())</span>
<span class="nc" id="L340">                            .build())</span>
<span class="nc" id="L341">                    .schedule(ScheduleDto.builder()</span>
<span class="nc" id="L342">                            .id(bookingDao.getSchedule().getId())</span>
<span class="nc" id="L343">                            .vaccinationDate(bookingDao.getSchedule().getVaccinationDate())</span>
<span class="nc" id="L344">                            .operationalHourStart(bookingDao.getSchedule().getOperationalHourStart())</span>
<span class="nc" id="L345">                            .operationalHourEnd(bookingDao.getSchedule().getOperationalHourEnd())</span>
<span class="nc" id="L346">                            .quota(bookingDao.getSchedule().getQuota())</span>
<span class="nc" id="L347">                            .dose(bookingDao.getSchedule().getDose())</span>
<span class="nc" id="L348">                            .facility(HealthFacilityDto.builder()</span>
<span class="nc" id="L349">                                    .id(optionalScheduleDao.get().getFacility().getId())</span>
<span class="nc" id="L350">                                    .facilityName(optionalScheduleDao.get().getFacility().getFacilityName())</span>
<span class="nc" id="L351">                                    .streetName(optionalScheduleDao.get().getFacility().getStreetName())</span>
<span class="nc" id="L352">                                    .officeNumber(optionalScheduleDao.get().getFacility().getOfficeNumber())</span>
<span class="nc" id="L353">                                    .villageName(optionalScheduleDao.get().getFacility().getVillageName())</span>
<span class="nc" id="L354">                                    .district(optionalScheduleDao.get().getFacility().getDistrict())</span>
<span class="nc" id="L355">                                    .city(optionalScheduleDao.get().getFacility().getCity())</span>
<span class="nc" id="L356">                                    .province(optionalScheduleDao.get().getFacility().getProvince())</span>
<span class="nc" id="L357">                                    .postalCode(optionalScheduleDao.get().getFacility().getPostalCode())</span>
<span class="nc" id="L358">                                    .profile(ProfileDto.builder()</span>
<span class="nc" id="L359">                                            .userId(optionalScheduleDao.get().getFacility().getProfile().getUserId())</span>
<span class="nc" id="L360">                                            .role(optionalScheduleDao.get().getFacility().getProfile().getRole())</span>
<span class="nc" id="L361">                                            .build())</span>
<span class="nc" id="L362">                                    .build())</span>
<span class="nc" id="L363">                            .vaccine(VaccineTypeDto.builder()</span>
<span class="nc" id="L364">                                    .id(optionalScheduleDao.get().getVaccine().getId())</span>
<span class="nc" id="L365">                                    .vaccineName(optionalScheduleDao.get().getVaccine().getVaccineName())</span>
<span class="nc" id="L366">                                    .build())</span>
<span class="nc" id="L367">                            .build())</span>
<span class="nc" id="L368">                    .build();</span>
<span class="nc" id="L369">            return ResponseUtil.build(AppConstant.ResponseCode.SUCCESS, dto, HttpStatus.OK);</span>
<span class="nc" id="L370">        } catch (Exception e) {</span>
<span class="nc" id="L371">            log.error(&quot;An error occurred in Updating Booking by id. Error {}&quot;, e.getMessage());</span>
<span class="nc" id="L372">            throw e;</span>
        }
    }

    public ResponseEntity&lt;Object&gt; deleteBookingById(Long id) {
        try {
<span class="fc" id="L378">            log.info(&quot;Deleting a Booking by id&quot;);</span>
<span class="fc" id="L379">            Optional&lt;BookingDao&gt; optionalBookingDao = bookingRepository.findById(id);</span>
<span class="pc bpc" id="L380" title="1 of 2 branches missed.">            if (optionalBookingDao.isEmpty()) {</span>
<span class="nc" id="L381">                log.info(&quot;Booking not found&quot;);</span>
<span class="nc" id="L382">                return ResponseUtil.build(AppConstant.ResponseCode.DATA_NOT_FOUND, null, HttpStatus.BAD_REQUEST);</span>
            }

<span class="fc" id="L385">            log.info(&quot;Booking found&quot;);</span>
<span class="fc" id="L386">            bookingRepository.delete(optionalBookingDao.get());</span>
<span class="fc" id="L387">            return ResponseUtil.build(AppConstant.ResponseCode.SUCCESS, null, HttpStatus.OK);</span>
<span class="nc" id="L388">        } catch (Exception e) {</span>
<span class="nc" id="L389">            log.error(&quot;An error occurred in deleting Booking by id. Error {}&quot;, e.getMessage());</span>
<span class="nc" id="L390">            throw e;</span>
        }
    }

    public ResponseEntity&lt;Object&gt; countBookingByScheduleId(Long scheduleId) {
        try {
<span class="nc" id="L396">            log.info(&quot;Counting registrant&quot;);</span>

<span class="nc" id="L398">            return ResponseUtil.build(AppConstant.ResponseCode.SUCCESS, bookingRepository.countBookingByScheduleId(scheduleId), HttpStatus.OK);</span>
<span class="nc" id="L399">        } catch (Exception e) {</span>
<span class="nc" id="L400">            log.info(&quot;An error occurred in Counting registrant. Error {}&quot;, e.getMessage());</span>
<span class="nc" id="L401">            throw e;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>